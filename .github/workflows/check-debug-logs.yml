name: Check debug logs in bug reports

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  check-logs-issue:
    if: >-
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for valid debug logs
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            // Extract debug logs section (between ### Debug logs and next ###)
            const match = body.match(/### Debug logs\s*\n([\s\S]*?)(?=\n### |$)/);
            const logsSection = match ? match[1].trim() : '';

            // Patterns that indicate real debug logs
            const logPatterns = [
              /\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/,   // log level
              /surveillance\.\w+/,                          // app logger
              /httpx: HTTP Request:/,                       // API call
            ];

            const hasLabel = context.payload.issue.labels.some(l => l.name === 'needs-debug-logs');
            const matchCount = logPatterns.filter(p => p.test(logsSection)).length;
            const isValid = logsSection.length > 100 && matchCount >= 2;

            if (!isValid) {
              // Add label if not present
              if (!hasLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['needs-debug-logs']
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: [
                    '**The debug logs section does not appear to contain valid debug logs.**',
                    '',
                    'Please run the application with `--debug` and capture the output:',
                    '',
                    '```sh',
                    'surveillance --debug 2> /tmp/debug.log',
                    '```',
                    '',
                    'Then reproduce the issue and paste the contents of `/tmp/debug.log` in the **Debug logs** field.',
                    'Passwords and session tokens are automatically redacted in the log output.',
                    '',
                    'This issue will remain labeled `needs-debug-logs` until valid logs are provided.',
                  ].join('\n')
                });
              }
            } else if (hasLabel) {
              // Valid logs found and label exists â€” remove it
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'needs-debug-logs'
                });
              } catch (e) {
                // Label might already be removed
              }
            }

  check-logs-comment:
    if: >-
      github.event_name == 'issue_comment' &&
      !github.event.issue.pull_request &&
      contains(github.event.issue.labels.*.name, 'needs-debug-logs')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check comment for debug logs
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch all comments on the issue
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              }
            );

            const logAttachmentPattern = /github\.com\/user-attachments\/files\/\d+\/[^\s)]+\.log\b/i;
            const logPatterns = [
              /\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/,   // log level
              /surveillance\.\w+/,                          // app logger
              /httpx: HTTP Request:/,                       // API call
            ];

            const hasLogs = comments.some(c => {
              const body = c.body || '';
              if (logAttachmentPattern.test(body)) return true;
              const matchCount = logPatterns.filter(p => p.test(body)).length;
              return body.length > 100 && matchCount >= 2;
            });

            if (hasLogs) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'needs-debug-logs'
                });
              } catch (e) {
                // Label might already be removed
              }
            }
