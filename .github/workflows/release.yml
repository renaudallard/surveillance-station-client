name: Release

on:
  push:
    branches: [main]
    paths:
      - pyproject.toml
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 0.1.0)"
        required: true

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: check
        run: |
          # Manual trigger: always proceed with the provided version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Manual trigger for version ${{ inputs.version }}"
            exit 0
          fi

          NEW=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          OLD=$(git show HEAD~1:pyproject.toml 2>/dev/null | grep '^version' | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo "")
          echo "version=${NEW}" >> "$GITHUB_OUTPUT"
          if [ "${NEW}" != "${OLD}" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: ${OLD} -> ${NEW}"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged: ${NEW}"
          fi

  build-appimage:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    # GitHub only offers Ubuntu host VMs; the actual build runs inside
    # a Debian trixie container.  Pinned by codename rather than
    # "stable"/"testing" so the build won't silently move to forky
    # (whose gdk-pixbuf requires glycin sandboxed loaders that break
    # inside AppImages).
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest    # x86_64 host VM
            arch: x86_64
          - runner: ubuntu-24.04-arm # aarch64 host VM
            arch: aarch64
    runs-on: ${{ matrix.runner }}
    container:
      image: debian:trixie
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
      DEBIAN_FRONTEND: noninteractive
      APPIMAGE_EXTRACT_AND_RUN: "1"
    steps:
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            python3 \
            python3-venv \
            python3-pip \
            python3-gi \
            python3-gi-cairo \
            python3-cairo \
            gir1.2-gtk-4.0 \
            libgtk-4-dev \
            libgirepository-2.0-dev \
            libmpv-dev \
            gobject-introspection \
            file \
            wget

      - uses: actions/checkout@v4

      - name: Create venv and install dependencies
        run: |
          python3 -m venv --system-site-packages .venv
          . .venv/bin/activate
          pip install --upgrade pip --break-system-packages
          pip install . pyinstaller --break-system-packages

      - name: Build AppImage
        run: |
          . .venv/bin/activate
          bash build-appimage.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-${{ matrix.arch }}
          path: Surveillance-*-${{ matrix.arch }}.AppImage

  release:
    needs: [check-version, build-appimage]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${VERSION}"

          # Collect AppImages from artifact directories
          mkdir -p release-assets
          find artifacts -name '*.AppImage' -exec cp {} release-assets/ \;
          ls -lh release-assets/

          # Upload to existing release or create a new one
          if gh release view "${TAG}" &>/dev/null; then
            gh release upload "${TAG}" release-assets/* --clobber
          else
            gh release create "${TAG}" \
              --title "Surveillance Station Client ${VERSION}" \
              --generate-notes \
              release-assets/*
          fi
